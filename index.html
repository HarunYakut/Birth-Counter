<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Birth Pulse - Data Verification Edition</title>
    <style>
        :root { --bg-color: #050a12; --deep-orange: #f59e0b; --map-blue: #38bdf8; --land-fill: #1a2b42; --border-color: #0a1424; }
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; }
        .container { display: flex; width: 100%; height: 100%; padding: 0 50px; box-sizing: border-box; align-items: center; }
        .stats-panel { flex: 0 0 28%; z-index: 20; }
        .count { font-size: 6.5rem; font-weight: 900; color: var(--deep-orange); text-shadow: 0 0 20px rgba(245,158,11,0.5); }
        .map-panel { flex: 1; height: 80%; position: relative; display: flex; align-items: center; justify-content: center; }
        .map-wrapper { position: relative; width: 100%; aspect-ratio: 2.5 / 1; }
        canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        #highlightCanvas { z-index: 3; }
        #loading-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-color); z-index: 2000; color: var(--map-blue); }
    </style>
</head>
<body>

    <div class="container">
        <div class="stats-panel">
            <div style="color:var(--map-blue); letter-spacing:3px;">WORLD BIRTHS TODAY</div>
            <div id="birthCount" class="count">0</div>
            <div id="clock" style="color:var(--deep-orange); font-weight:bold; font-size:1.2rem;">00:00:00</div>
        </div>

        <div class="map-panel">
            <div class="map-wrapper" id="mapFrame">
                <div id="loading-overlay">
                    <div style="letter-spacing: 5px; font-weight: bold;">VERIFYING DATA MATCHES...</div>
                    <div id="load-status" style="font-size: 10px; margin-top: 10px; opacity: 0.5; font-family: monospace;">Check F12 Console for full logs</div>
                </div>
                <canvas id="landCanvas"></canvas>
                <canvas id="borderCanvas"></canvas>
                <canvas id="highlightCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Senin gönderdiğin en güncel Nüfus x CBR verileri
        const masterData = {
            IND: 18.29, CHN: 17.69, USA: 4.34, IDN: 3.57, PAK: 3.19, NGA: 2.97, BRA: 2.66, BGD: 2.19, RUS: 1.80, ETH: 1.69, 
            MEX: 1.65, JPN: 1.54, EGY: 1.48, PHL: 1.46, COD: 1.41, VNM: 1.27, IRN: 1.15, TUR: 1.10, DEU: 1.05, THA: 0.89, 
            TZA: 0.88, GBR: 0.87, FRA: 0.83, ZAF: 0.81, ITA: 0.74, KEN: 0.72, MMR: 0.69, COL: 0.67, KOR: 0.65, SDN: 0.65
        };

        const BIRTH_RATE = 367000 / 86400000;
        const LAT_TOP = 85, LAT_BOTTOM = -58, LAT_RANGE = LAT_TOP - LAT_BOTTOM;
        
        let worldData = []; 
        let activeFlashes = []; 

        const landCanvas = document.getElementById('landCanvas');
        const borderCanvas = document.getElementById('borderCanvas');
        const highlightCanvas = document.getElementById('highlightCanvas');
        const hCtx = highlightCanvas.getContext("2d");

        fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
            .then(r => r.json())
            .then(init);

        async function init(geo) {
            const w = 2400, h = Math.round(w / (360 / LAT_RANGE)); 
            landCanvas.width = borderCanvas.width = highlightCanvas.width = w;
            landCanvas.height = borderCanvas.height = highlightCanvas.height = h;
            const lCtx = landCanvas.getContext("2d");
            const bCtx = borderCanvas.getContext("2d");

            console.log("--- DATA VERIFICATION START ---");
            let verifyTable = [];

            const features = geo.features;
            for (let i = 0; i < features.length; i++) {
                const f = features[i];
                const props = f.properties;
                
                // DEDEKTİF MANTİĞİ: Tüm datayı string yapıp arıyoruz
                const metaString = JSON.stringify(props).toLowerCase();
                let iso = (props.ISO_A3 || props.ADM0_A3 || props.GU_A3 || "UNK").toUpperCase();
                let originalName = props.ADMIN || props.NAME || "Unknown";

                // Manuel Düzeltmeler (Eşleşmeyi garantilemek için)
                if (metaString.includes("india")) iso = "IND";
                if (metaString.includes("china")) iso = "CHN";
                if (metaString.includes("united states")) iso = "USA";
                if (metaString.includes("turkey") || metaString.includes("türkiye")) iso = "TUR";

                if (iso === "ATA") continue; // Antarktika'yı geç

                const weight = masterData[iso] || 0.05; // Listede yoksa 0.05 ver (küçük ihtimal)

                // Konsol için tabloya ekle
                verifyTable.push({ Name: originalName, ISO_Found: iso, Weight: weight });

                const p2d = new Path2D();
                const coords = f.geometry.type === "Polygon" ? [f.geometry.coordinates] : f.geometry.coordinates;
                coords.forEach(poly => poly.forEach(ring => ring.forEach((p, idx) => {
                    const px = (p[0] + 180) / 360 * w;
                    const py = (LAT_TOP - p[1]) / LAT_RANGE * h;
                    if (idx === 0) p2d.moveTo(px, py); else p2d.lineTo(px, py);
                })));

                worldData.push({ path: p2d, weight: weight, iso: iso });

                // Çizim
                lCtx.fillStyle = "#1a2b42"; lCtx.fill(p2d);
                bCtx.strokeStyle = "#0a1424"; bCtx.lineWidth = 0.8; bCtx.stroke(p2d);

                if (i % 50 === 0) await new Promise(r => setTimeout(r, 0));
            }

            // DOĞRULAMA: Konsola tabloyu bas!
            console.table(verifyTable);
            console.log("Total Countries Linked: ", worldData.length);

            document.getElementById('loading-overlay').style.display = "none";
            startSimulation();
        }

        function triggerFlash() {
            const totalWeight = worldData.reduce((s, c) => s + c.weight, 0);
            let r = Math.random() * totalWeight;
            for (let country of worldData) {
                r -= country.weight;
                if (r <= 0) {
                    activeFlashes.push({ path: country.path, start: Date.now() });
                    break;
                }
            }
        }

        function startSimulation() {
            setInterval(() => {
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                document.getElementById('birthCount').innerText = Math.floor((now - start) * BIRTH_RATE).toLocaleString();
                document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB');
            }, 1000);

            let lastT = Date.now(), carry = 0;
            function loop() {
                const now = Date.now();
                carry += Math.min(now - lastT, 1000) * BIRTH_RATE;
                lastT = now;
                while (carry >= 1) { triggerFlash(); carry--; }

                hCtx.clearRect(0, 0, 2400, 1200);
                hCtx.globalCompositeOperation = 'lighter'; 
                activeFlashes = activeFlashes.filter(f => {
                    const age = now - f.start;
                    if (age >= 1200) return false;
                    const op = Math.pow(1 - age / 1200, 1.6);
                    hCtx.fillStyle = `rgba(245, 158, 11, ${op * 0.9})`;
                    hCtx.fill(f.path);
                    return true;
                });
                requestAnimationFrame(loop);
            }
            loop();
        }
    </script>
</body>
</html>