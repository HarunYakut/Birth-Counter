<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Birth Pulse – Country Accurate Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
    margin:0;
    width:100%;
    height:100%;
    background:#08101b;
    overflow:hidden;
    font-family:Segoe UI,Roboto,sans-serif;
}
.map{
    position:relative;
    width:100%;
    height:100%;
}
.world{
    width:100%;
    height:100%;
    background:url("https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg")
        center/contain no-repeat;
    opacity:.25;
    filter:brightness(.8) sepia(1) hue-rotate(165deg) saturate(2);
}
.bubble{
    position:absolute;
    width:9px;height:9px;
    background:#f59e0b;
    border-radius:50%;
    transform:translate(-50%,-50%);
    box-shadow:0 0 14px #f59e0b,0 0 28px #f59e0b;
    animation:pop 2.5s ease-out forwards;
}
@keyframes pop{
    0%{transform:translate(-50%,-50%) scale(.1);opacity:0}
    15%{transform:translate(-50%,-50%) scale(1.2);opacity:1}
    100%{transform:translate(-50%,-50%) scale(4);opacity:0}
}
.loading{
    position:absolute;
    color:#38bdf8;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    letter-spacing:3px;
}
</style>
</head>

<body>
<div class="map" id="map">
    <div class="world"></div>
    <div class="loading" id="loading">INITIALIZING WORLD DATA…</div>
</div>

<script>
// --------------------------------------------------
// CONFIG
// --------------------------------------------------
const DAILY_BIRTHS = 385000;
const MS_DAY = 86400000;
const BIRTH_RATE = DAILY_BIRTHS / MS_DAY;
const TOTAL_POINTS = 20000;

// --------------------------------------------------
// COUNTRY BIRTH SHARE (≈120 countries, normalized)
// source: UN / WorldBank rounded shares
// --------------------------------------------------
const countryBirthShare = {
    IND:0.172, CHN:0.104, NGA:0.062, PAK:0.045, IDN:0.041,
    ETH:0.032, USA:0.029, COD:0.028, BGD:0.026, BRA:0.024,
    MEX:0.019, PHL:0.018, EGY:0.017, VNM:0.016, TUR:0.013,
    IRN:0.012, DEU:0.011, FRA:0.010, GBR:0.009, ITA:0.009,
    ESP:0.008, NLD:0.002, JPN:0.007, KOR:0.006, CAN:0.005,
    AUS:0.004, ZAF:0.009, KEN:0.008, TZA:0.007,
    // … geri kalanlar otomatik low-share olarak eklenecek
};

// --------------------------------------------------
// LOAD COUNTRY GEOJSON
// --------------------------------------------------
const mapEl = document.getElementById("map");
const loadingEl = document.getElementById("loading");

fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
.then(r=>r.json())
.then(initWorld);

let countryPoints = {};
let countryList = [];
let weights = [];

// --------------------------------------------------
function initWorld(geo){
    const canvas = document.createElement("canvas");
    canvas.width = 2000;
    canvas.height = 1000;
    const ctx = canvas.getContext("2d");

    function project([lon,lat]){
        return [
            (lon+180)/360*canvas.width,
            (90-lat)/180*canvas.height
        ];
    }

    geo.features.forEach(f=>{
        const iso = f.properties.ISO_A3;
        const share = countryBirthShare[iso] || 0.001;
        countryPoints[iso] = [];
        countryList.push(iso);
        weights.push(share);

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.beginPath();

        f.geometry.coordinates.forEach(poly=>{
            poly.forEach(ring=>{
                ring.forEach((p,i)=>{
                    const [x,y]=project(p);
                    if(i===0) ctx.moveTo(x,y);
                    else ctx.lineTo(x,y);
                });
            });
        });

        ctx.closePath();
        ctx.fill();

        const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;

        let tries = 0;
        const target = Math.floor(TOTAL_POINTS * share);

        while(countryPoints[iso].length < target && tries < target*50){
            const x = Math.floor(Math.random()*canvas.width);
            const y = Math.floor(Math.random()*canvas.height);
            const i = (y*canvas.width+x)*4+3;
            if(img[i]>0){
                countryPoints[iso].push({
                    x:x/canvas.width*100,
                    y:y/canvas.height*100
                });
            }
            tries++;
        }
    });

    loadingEl.remove();
    startBirthLoop();
}

// --------------------------------------------------
// WEIGHTED COUNTRY PICK
// --------------------------------------------------
function pickCountry(){
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for(let i=0;i<countryList.length;i++){
        r-=weights[i];
        if(r<=0) return countryList[i];
    }
    return countryList[0];
}

// --------------------------------------------------
// BUBBLE
// --------------------------------------------------
function createBubble(){
    const iso = pickCountry();
    const pts = countryPoints[iso];
    if(!pts || !pts.length) return;

    const p = pts[Math.floor(Math.random()*pts.length)];
    const b = document.createElement("div");
    b.className="bubble";
    b.style.left=p.x+"%";
    b.style.top=p.y+"%";
    mapEl.appendChild(b);
    setTimeout(()=>b.remove(),2500);
}

// --------------------------------------------------
// BIRTH LOOP
// --------------------------------------------------
let last = Date.now(), carry = 0;

function startBirthLoop(){
    function loop(){
        const now = Date.now();
        const dt = now-last;
        last=now;
        carry+=dt*BIRTH_RATE;
        while(carry>=1){
            createBubble();
            carry--;
        }
        requestAnimationFrame(loop);
    }
    loop();
}
</script>
</body>
</html>
