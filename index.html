<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Birth Pulse – Pro Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    html,body{
        margin:0; width:100%; height:100%;
        background:#08101b; overflow:hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .map{ position:relative; width:100%; height:100%; }
    .world{
        width:100%; height:100%;
        background:url("https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg")
            center/contain no-repeat;
        opacity:.15;
        filter:brightness(.8) sepia(1) hue-rotate(165deg) saturate(2);
    }
    /* Doğum Patlaması */
    .bubble{
        position:absolute; width:10px; height:10px;
        background:#f59e0b; border-radius:50%;
        transform:translate(-50%,-50%);
        box-shadow:0 0 15px #f59e0b, 0 0 30px #f59e0b;
        animation:pop 2s ease-out forwards;
        pointer-events: none;
    }
    @keyframes pop{
        0%{transform:translate(-50%,-50%) scale(.1); opacity:0}
        15%{transform:translate(-50%,-50%) scale(1.2); opacity:1}
        100%{transform:translate(-50%,-50%) scale(5); opacity:0}
    }

    /* Yükleme Ekranı ve Progress Bar */
    #loading-screen {
        position: absolute; top:50%; left:50%;
        transform:translate(-50%, -50%);
        text-align: center; width: 300px;
        color: #38bdf8; font-weight: bold; letter-spacing: 2px;
    }
    .progress-container {
        width: 100%; height: 6px; background: #1e293b;
        border-radius: 10px; margin-top: 15px; overflow: hidden;
    }
    #progress-bar {
        width: 0%; height: 100%; background: #38bdf8;
        box-shadow: 0 0 10px #38bdf8; transition: width 0.1s;
    }
    #status-text { font-size: 12px; margin-top: 8px; opacity: 0.8; }
</style>
</head>

<body>

<div class="map" id="map">
    <div class="world"></div>
    
    <!-- Yükleme Alanı -->
    <div id="loading-screen">
        <div id="loading-title">INITIALIZING WORLD DATA</div>
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="status-text">Fetching GeoJSON...</div>
    </div>
</div>

<script>
const DAILY_BIRTHS = 385000;
const MS_DAY = 86400000;
const BIRTH_RATE = DAILY_BIRTHS / MS_DAY;
const TOTAL_POINTS = 25000; // Daha hassas harita için artırdık

const countryBirthShare = {
    IND:0.172, CHN:0.104, NGA:0.062, PAK:0.045, IDN:0.041,
    ETH:0.032, USA:0.029, COD:0.028, BGD:0.026, BRA:0.024,
    MEX:0.019, PHL:0.018, EGY:0.017, VNM:0.016, TUR:0.013,
    IRN:0.012, DEU:0.011, FRA:0.010, GBR:0.009, ITA:0.009,
    ESP:0.008, NLD:0.002, JPN:0.007, KOR:0.006, CAN:0.005,
    AUS:0.004, ZAF:0.009, KEN:0.008, TZA:0.007
};

const mapEl = document.getElementById("map");
const progressBar = document.getElementById("progress-bar");
const statusText = document.getElementById("status-text");
const loadingScreen = document.getElementById("loading-screen");

let countryPoints = {};
let countryList = [];
let weights = [];

// 1. ADIM: GeoJSON Yükle
fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
    .then(r => r.json())
    .then(data => processCountries(data));

// 2. ADIM: Ülkeleri Sırayla İşle (Async)
async function processCountries(geo) {
    const canvas = document.createElement("canvas");
    canvas.width = 2000; canvas.height = 1000;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    function project([lon, lat]) {
        return [(lon + 180) / 360 * canvas.width, (90 - lat) / 180 * canvas.height];
    }

    const features = geo.features;
    for (let i = 0; i < features.length; i++) {
        const f = features[i];
        const iso = f.properties.ISO_A3;
        const name = f.properties.ADMIN || iso;
        const share = countryBirthShare[iso] || 0.001;

        countryPoints[iso] = [];
        countryList.push(iso);
        weights.push(share);

        // UI Güncelleme (Progress Bar)
        const percent = Math.floor((i / features.length) * 100);
        progressBar.style.width = percent + "%";
        statusText.innerText = `Mapping: ${name} (${percent}%)`;

        // Haritaya çiz
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        f.geometry.coordinates.forEach(poly => {
            const rings = f.geometry.type === "MultiPolygon" ? poly : [poly];
            rings.forEach(ring => {
                ring.forEach((p, idx) => {
                    const [x, y] = project(p);
                    if (idx === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
            });
        });
        ctx.fill();

        // Noktaları üret (Point-in-Polygon)
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const target = Math.floor(TOTAL_POINTS * share);
        let tries = 0;
        while (countryPoints[iso].length < target && tries < target * 30) {
            const x = Math.floor(Math.random() * canvas.width);
            const y = Math.floor(Math.random() * canvas.height);
            if (img[(y * canvas.width + x) * 4 + 3] > 0) {
                countryPoints[iso].push({ x: x / canvas.width * 100, y: y / canvas.height * 100 });
            }
            tries++;
        }

        // Kritik Nokta: Tarayıcının nefes almasına izin ver (Frame atlamasın)
        if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
    }

    // İşlem Tamam
    loadingScreen.style.display = "none";
    startBirthLoop();
}

function pickCountry() {
    const total = weights.reduce((a, b) => a + b, 0);
    let r = Math.random() * total;
    for (let i = 0; i < countryList.length; i++) {
        r -= weights[i];
        if (r <= 0) return countryList[i];
    }
    return countryList[0];
}

function createBubble() {
    const iso = pickCountry();
    const pts = countryPoints[iso];
    if (!pts || !pts.length) return;
    const p = pts[Math.floor(Math.random() * pts.length)];
    
    const b = document.createElement("div");
    b.className = "bubble";
    b.style.left = p.x + "%";
    b.style.top = p.y + "%";
    mapEl.appendChild(b);
    setTimeout(() => b.remove(), 2000);
}

let last = Date.now(), carry = 0;
function startBirthLoop() {
    function loop() {
        const now = Date.now();
        const dt = now - last;
        last = now;
        carry += dt * BIRTH_RATE;
        while (carry >= 1) {
            createBubble();
            carry--;
        }
        requestAnimationFrame(loop);
    }
    loop();
}
</script>
</body>
</html>